{% extends 'articles/base_articles.html' %}

{% block title %}
    {{ article.title }}
{% endblock %}


{% block content %}
<style>
    .likes {
        cursor: pointer;    
    }
</style>
<div class="col" style="margin-top: 5rem">
    <div class="card" style="max-width: 1440px; margin: auto;">
        <div class="row no-gutters">
            <div class="col-md-2">
                <div class="card-header"></div>
                {% if article.img %}
                    <img src="{{ article.img.url }}" class="card-img-top" alt="pic">
                {% else %}
                    <img src="/static/images/def.png" class="card-img-top" alt="pic">
                {% endif %}
            </div>
            <div class="col-md-10">
                <div class="card-header">
                </div>
                <div class="card-body">
                    <h5 class="card-title">
                        {{ article.title }} 
                    </h5>
                    <small class="text">
                        {% for state in article.states.all %}
                            <i class="likes fa-solid fa-thumbs-up fa-lg text-primary">&nbsp&nbsp{{ state.likes }}&nbsp&nbsp</i>
                            <i class="fa-solid fa-eye fa-lg text-danger">&nbsp&nbsp{{ state.views }}&nbsp&nbsp</i> 
                        {% endfor %}
                        {{ article.pub_date|date:'d-m-Y  H:i:s' }}   
                    </small>
                    <p class="card-text">
                        {% autoescape off %}
                        {{ article.body|linebreaks }}
                        {% endautoescape %}
                    </p>
                </div>
                {% if request.user.is_authenticated and request.user.is_staff %}
                    <button class="btn btn-primary"><a href="{{ article.get_update_url }}" style="color:white; text-decoration: none;">Редактировать</a></button>
                    <button class="btn btn-danger"><a href="{{ article.get_delete_url }}" style="color:white; text-decoration: none;">Удалить</a></button>
                {% endif %}
                <div class="card-text">
                    <small class="text-muted">
                        {% for tag in article.tags.all %}
                            <i class="fa-solid fa-tags fa-lg"></i><a class="" href="{{ tag.get_absolute_url }}">&nbsp{{ tag.label }}&nbsp</a>
                        {% endfor %}
                    </small>
                </div>
                <div class="card-footer mt-3">
                    Комментарии:
                    {% if article.comments.all %}
                    {% for comment in page.object_list %}
                    <hr>
                    <hr>
                    <p><strong>{{ comment.author}}</strong></p>
                    <p>{{ comment.text}}</p>
                    <p>{{ comment.pub_date|date:'d-m-Y  H:i:s' }}</p>
                    {% endfor %}
                    {% else %}
                    будь первым кто оставит комментарий
                    {% endif %}
                    <!-- Pagination comments -->
                    {% block pagination_comments %}
                        {% include 'articles/includes/pagination_template.html' %}
                    {% endblock %}
                    <!-- End pagination -->
                    <!-- Form comments -->
                    {% if request.user.is_authenticated %}
                    <form style="margin-top: 2rem;" method="post">
                        {% csrf_token %}
                        {% for field in form %}  
                        <div class="form-group col-ms-6">
                            {% if field.errors %}
                                <div class="alert alert-danger">
                                    {{ field.errors }}
                                </div>
                            {% endif %}
                
                            {{ field.label }}
                            {{ field }}
                        </div>
                        {% endfor %}
                        <button type="submit" class="btn btn-primary">Отправить</button>
                    </form>
                    {% endif %}
                    <!-- End form -->
                </div>
            </div>
        </div>
    </div>
    <!-- Likes button -->
    <script> 
        let button = document.querySelector('.likes')
        button.onclick = async function(event) {
            let body = new FormData();
            body.append('statistics','like');
            let request = await fetch("{% url 'article_detail_url' slug=article.slug %}", {
                method: 'POST',
                headers: {'X-CSRFToken': '{{ csrf_token }}'}, 
                body: body});
            console.log(request);      
            let response = await request.json();
            console.log(response)
            document.querySelector('.likes').innerHTML = '&nbsp&nbsp' + response['likes'] + '&nbsp&nbsp';
                     
        };
    </script>
    <!-- End  -->
</div>
{% endblock %}



